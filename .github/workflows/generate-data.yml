name: Generate data (manual)

on:
  schedule:
    # Daily at 00:30 UTC (adjust as needed)
    - cron: "30 0 * * *"
  workflow_dispatch:
    inputs:
      universe_kr:
        description: "KR universe limit (e.g. 200)"
        required: false
        default: "30"
      universe_us:
        description: "US universe limit (e.g. 100)"
        required: false
        default: "30"
      enable_news:
        description: "Enable news collection (1/0)"
        required: false
        default: "0"
      enable_fundamentals:
        description: "Enable fundamentals collection (1/0)"
        required: false
        default: "0"

permissions:
  contents: write

concurrency:
  group: generate-data
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Needed for pull/rebase
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r web/backend/requirements.txt

      - name: Generate JSON snapshots
        env:
          # Use an ephemeral SQLite DB inside the runner workspace (do NOT commit DB files).
          DATABASE_URL: sqlite:///./data/ci.db
          # For scheduled runs, github.event.inputs is empty -> fall back to safe defaults.
          ENABLE_NEWS: ${{ github.event.inputs.enable_news || '0' }}
          ENABLE_FUNDAMENTALS: ${{ github.event.inputs.enable_fundamentals || '0' }}
          UNIVERSE_LIMIT_KR: ${{ github.event.inputs.universe_kr || '30' }}
          UNIVERSE_LIMIT_US: ${{ github.event.inputs.universe_us || '30' }}
          # Optional provider keys (set as GitHub Secrets if you have them)
          DART_API_KEY: ${{ secrets.DART_API_KEY }}
          ALPHAVANTAGE_API_KEY: ${{ secrets.ALPHAVANTAGE_API_KEY }}
        run: |
          cd web/backend
          mkdir -p data
          python -m app.static_export

      - name: Commit generated data
        run: |
          git status
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add web/frontend/public/data
          git commit -m "Update data snapshots"
          # Remote main may advance while this job runs (e.g., new commits pushed).
          # Rebase our snapshot commit on top of latest main, then retry push.
          for i in 1 2 3; do
            git pull --rebase origin main || true
            if git push; then
              exit 0
            fi
            echo "Push failed (attempt $i). Retrying..."
            sleep 5
          done
          echo "Push failed after retries."
          exit 1

